<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>COUNTDOWN - Final Stable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Pretendard:wght@700;900&display=swap');
        body { margin: 0; background: #000; color: white; font-family: 'Pretendard', sans-serif; overflow: hidden; height: 100dvh; }
        
        /* ìº”ë²„ìŠ¤ ìš°ì„  ë°°ì¹˜ */
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* UI ë ˆì´ì–´: í´ë¦­ ê´€í†µ ì„¤ì • */
        .ui-layer { position: relative; z-index: 10; pointer-events: none; height: 100%; display: flex; flex-direction: column; justify-content: space-between; padding: 1.5rem; }
        .interactive { pointer-events: auto; }
        .title-font { font-family: 'Black Han Sans', sans-serif; }

        /* í•˜ë‹¨ ë‹¬ë¦¬ê¸° íŠ¸ë™ */
        #track { position: fixed; bottom: 130px; left: 50%; transform: translateX(-50%); width: 85%; height: 60px; background: rgba(255,255,255,0.1); border-radius: 30px; border: 1px solid rgba(250,204,21,0.3); z-index: 20; }
        #runner-emoji { position: absolute; left: 0; top: 50%; transform: translateY(-50%); font-size: 30px; transition: left 0.5s ease-out; filter: drop-shadow(0 0 8px gold); }

        /* í™•ëŒ€ê²½: ì ˆëŒ€ ì–´ë‘¡ì§€ ì•Šê²Œ ê³ ì • */
        #magnifier { position: fixed; right: 20px; top: 40%; width: 160px; height: 160px; border-radius: 40px; border: 3px solid #facc15; overflow: hidden; z-index: 30; background: #050505; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div class="ui-layer">
        <div class="flex flex-col items-start">
            <h1 class="text-yellow-400 text-5xl font-black title-font italic">COUNTDOWN</h1>
            <div class="bg-red-600 px-4 py-1 rounded-lg mt-2 font-black text-2xl" id="dday-val">D-00</div>
        </div>

        <div class="flex flex-col items-center gap-2">
            <div class="flex items-center gap-4 bg-black/60 p-6 rounded-[3rem] border border-white/20 backdrop-blur-md">
                <div class="text-center">
                    <span class="title-font text-8xl md:text-9xl" id="km-val">0.0</span>
                    <span class="text-xl text-slate-400 font-bold ml-1">km</span>
                </div>
                <div class="w-1 bg-white/20 h-20"></div>
                <div class="text-yellow-400 text-6xl md:text-8xl font-black italic" id="percent-val">0.0%</div>
            </div>
        </div>

        <div class="w-full max-w-sm mx-auto flex flex-col gap-6">
            <div id="track" class="interactive">
                <div id="runner-emoji">ğŸƒâ€â™‚ï¸</div>
            </div>
            <button onclick="openModal()" class="interactive w-full py-7 bg-yellow-400 text-black rounded-[2.5rem] font-black text-3xl shadow-2xl hover:scale-105 transition-transform active:scale-95">
                ê¸°ë¡ ì¶”ê°€í•˜ê¸°
            </div>
        </div>
    </div>

    <div id="magnifier" class="interactive"></div>

    <div id="modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/90 p-6 backdrop-blur-xl">
        <div class="bg-zinc-900 w-full max-w-xs p-8 rounded-[40px] border border-white/10 text-center">
            <h3 class="title-font text-2xl text-yellow-400 mb-6">ì˜¤ëŠ˜ ì–¼ë§ˆë‚˜ ê±¸ì—ˆë‚˜ìš”?</h3>
            <input type="number" id="km-input" placeholder="0.0" class="w-full bg-white/5 border-2 border-white/10 rounded-2xl p-5 text-4xl font-bold text-center text-white mb-6 focus:border-yellow-400 outline-none">
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-4 text-slate-400 font-bold">ì·¨ì†Œ</button>
                <button onclick="saveRecord()" class="flex-1 py-4 bg-yellow-400 text-black rounded-2xl font-black">ì €ì¥</button>
            </div>
        </div>
    </div>

    <script>
        let scene, camera, renderer, globe, marker, controls, zoomCamera;
        let totalKm = parseFloat(localStorage.getItem('earth_walk_v9')) || 0;
        const CIRCUM = 40075;

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 7;

            // í™•ëŒ€ ì¹´ë©”ë¼
            zoomCamera = new THREE.PerspectiveCamera(15, 1, 0.01, 20);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // ì¡°ëª… (ì§€êµ¬ê°€ ì ˆëŒ€ ì•ˆ ë³´ì´ê²Œ í•˜ì§€ ì•ŠìŒ)
            const ambient = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambient);
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(5, 5, 5);
            scene.add(sun);

            // ì§€êµ¬ ìƒì„± (í…ìŠ¤ì²˜ ë¡œë“œ ì‹¤íŒ¨í•´ë„ íŒŒë€ êµ¬ì²´ë¡œ ë³´ì„)
            const geo = new THREE.SphereGeometry(2, 64, 64);
            const mat = new THREE.MeshPhongMaterial({ color: 0x1562ad });
            globe = new THREE.Mesh(geo, mat);
            scene.add(globe);

            // í…ìŠ¤ì²˜ ì…íˆê¸° (ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰)
            new THREE.TextureLoader().load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg', (tex) => {
                mat.map = tex;
                mat.needsUpdate = true;
            });

            // ë§ˆì»¤
            marker = new THREE.Mesh(
                new THREE.SphereGeometry(0.05, 16, 16),
                new THREE.MeshBasicMaterial({ color: 0xffff00 })
            );
            scene.add(marker);

            // ì»¨íŠ¸ë¡¤
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.enableZoom = false;

            updateDDay();
            updateUI(totalKm);
            animate();
        }

        function updateDDay() {
            const diff = Math.ceil((new Date(2026, 5, 19) - new Date()) / (1000*60*60*24));
            document.getElementById('dday-val').innerText = `D-${diff > 0 ? diff : 0}`;
        }

        function updateUI(km) {
            const ratio = Math.min(km / CIRCUM, 1);
            document.getElementById('km-val').innerText = km.toFixed(1);
            document.getElementById('percent-val').innerText = (ratio * 100).toFixed(1) + "%";
            
            // ğŸƒâ€â™‚ï¸ ëŸ¬ë„ˆ ì´ë™
            const trackWidth = document.getElementById('track').offsetWidth;
            document.getElementById('runner-emoji').style.left = `${ratio * (trackWidth - 40)}px`;

            // ë§ˆì»¤ ìœ„ì¹˜ ê³„ì‚°
            const angle = (km / CIRCUM) * Math.PI * 2;
            marker.position.set(Math.sin(angle) * 2.05, Math.cos(angle) * 2.05, 0);

            // í™•ëŒ€ê²½ ì¹´ë©”ë¼ ì¶”ì 
            zoomCamera.position.copy(marker.position).multiplyScalar(1.5);
            zoomCamera.lookAt(marker.position);
        }

        function openModal() { document.getElementById('modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function saveRecord() {
            const val = parseFloat(document.getElementById('km-input').value);
            if (val > 0) {
                const start = totalKm;
                totalKm += val;
                localStorage.setItem('earth_walk_v9', totalKm);
                
                // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
                gsap.to({v: start}, {
                    v: totalKm,
                    duration: 2,
                    onUpdate: function() { updateUI(this.targets()[0].v); }
                });
                
                document.getElementById('km-input').value = "";
                closeModal();
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            globe.rotation.y += 0.001;
            controls.update();

            // ë©”ì¸ ë·°
            renderer.setViewport(0, 0, window.innerWidth, window.innerHeight);
            renderer.setScissorTest(false);
            renderer.render(scene, camera);

            // í™•ëŒ€ê²½ ë·°
            const mag = document.getElementById('magnifier');
            const rect = mag.getBoundingClientRect();
            renderer.setScissorTest(true);
            renderer.setScissor(rect.left, window.innerHeight - rect.bottom, rect.width, rect.height);
            renderer.setViewport(rect.left, window.innerHeight - rect.bottom, rect.width, rect.height);
            renderer.render(scene, zoomCamera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        init();
    </script>
</body>
</html>
